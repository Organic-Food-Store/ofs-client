<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="app-theme.html">
<dom-module id="food-grid">
    <style include="app-theme">
        :host {
            display: block;
        }

        #grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        paper-tabs {
            margin-top: 1px;
            margin-bottom: 12.5px;
        }

        paper-button {
            --paper-button-ink-color: var(--primary-color);
            color: var(--primary-text-color);
            background-color: var(--accent-color);
            font-weight: 500;
            font-size: x-large;
            margin: 0px 0px 14.5px 0px;
            display: flex;
            text-align: center;
        }
    </style>
    <template>
        <firebase-document
            path="/categories"
            data="{{latestCategories}}">
        </firebase-document>
        <firebase-document
            path="/stores/[[storeId]]/stock"
            data="{{stockData}}">
        </firebase-document>
        <template is="dom-if" if="[[show(cart, store, itemCount, cartCount)]]">
            <a class="linkNullify" href="/cart" tabindex="-1"><paper-button raised>Proceed to Cart</paper-button></a>
        </template>
        <template is="dom-if" if="[[store]]">
            <paper-input
                autocorrect="off"
                label="Search"
                type="string"
                value="{{search}}">
            </paper-input>
        </template>
        <paper-tabs selected="{{menuSelect}}">
            <paper-tab>All</paper-tab>
            <template is="dom-repeat" items="[[getObjectValues(latestCategories)]]">
                <paper-tab>[[capitalize(item)]]</paper-tab>
            </template>
        </paper-tabs>
        <div id="grid">
            <template id="rGrid" is="dom-repeat" items="[[getObjectValues(stockData)]]" filter="matchesFilters">
                <food-card
                    id="food[[item.id]]"
                    store="{{store}}"
                    cart="{{cart}}"
                    item="[[item]]"
                    user-id="[[userId]]"
                    store-id="[[storeId]]">
                </food-card>
            </template>
        </div>
        <template is="dom-if" if="[[!show(cart, store, itemCount, cartCount)]]" class="center">
            <template is="dom-if" if="[[store]]">
                <h4><b>Your Stock Selection is Empty!</b><br>Select a different store:<br><br><menu-select store></menu-select><br><br>Or change your:<br><b>Search Query Keywords</b></h4><br>
            </template>
            <template is="dom-if" if="[[cart]]">
                <h4><b>Your Cart is Empty!</b><br>Add items to your cart here:<br></h4><a class="linkNullify" name="cart" href="/store" tabindex="-1"><paper-button raised>Store</paper-button></a><br>
            </template>
        </template>
        <template is="dom-if" if="[[show(cart, store, itemCount, cartCount)]]">
            <a class="linkNullify" href="/checkout" tabindex="-1"><paper-button raised>Proceed to Checkout</paper-button></a>
        </template>
        <!--<paper-textarea label="Food-Grid Data" value="[[parseJson(userId, storeId, menuSelect, category, latestCategories, stockData)]]"></paper-textarea>-->
    </template>
    <script>
        Polymer({
            is: 'food-grid',
            properties: {
                stockData: {
                    type: Object,
                    observer: 'refreshGrid'
                }, itemCount: {
                    type: Number,
                    notify: true,
                    value: 0
                }, cartCount: {
                    type: Number,
                    notify: true,
                    value: 0
                }, store: {
                    type: Boolean,
                    notify: true,
                    value: false,
                    observer: 'refreshGrid'
                }, cart: {
                    type: Boolean,
                    notify: true,
                    value: false,
                    observer: 'refreshGrid'
                }, category: {
                    type: String,
                    notify: true,
                    computed: "getCurrentCategory(menuSelect, latestCategories)",
                    observer: 'refreshGrid'
                }, menuSelect: {
                    type: Number,
                    value: 0,
                    notify: true,
                    observer: 'refreshGrid'
                }, search: {
                    type: String,
                    value: "",
                    notify: true,
                    observer: 'refreshGrid'
                }
            },
            listeners: {
                'change': 'cartRefresh'
            },
            show: function(c, s, itemCount, cartCount) {
                return view && itemCount > 1;
            },
            dontShow: function(itemCount, c, s) {
                console.log(itemCount);
                console.log(c);
                console.log(s);
                console.log(itemCount < 2 && (c || s));
                return itemCount < 2 && (c || s);
            },
            getCurrentCategory: function(m, c) {
                if (m == 0) return "all";
                return c[m - 1];
            },
            cartRefresh: function() {
                cartSum = 0;
                for(var food in this.getObjectKeys(this.stockData))
                    if(this.itemCount > 1) console.log(this.$$("#food"+this.getObjectKeys(this.stockData)[food]).quanta);
                this.set("cartCount", cartSum);
            },
            refreshGrid: function() {
                this.$.rGrid.render();
                this.set("itemCount", this.$.grid.childElementitemCount);
                // console.log(this.$.grid.childElementitemCount);
                // console.log(this.stockData);
                // console.log(this.cartCount);
                // console.log(this.itemCount);
                // for(var food in this.getObjectKeys(this.stockData))
                //     if(this.itemCount > 1) console.log(this.$$("#food"+this.getObjectKeys(this.stockData)[food]).customStyle['--show-food-card']);
                // // console.log(this.$$("#foodapple").customStyle['--show-food-card']);
                console.log("Food Grid Item itemCount - this.itemCount");
                console.log(this.itemCount);
            },
            matchesFilters: function(item) {
                var show = true;
                if(this.category != "all")
                    show = (item.category == this.category);
                if(show && this.search == "")
                    return true;
                return ((item.id+item.description).toLowerCase().indexOf(this.search) >= 0);
            },
            capitalize: function (str) {
                return capStr(str);
            },
            getObjectKeys: function (items) {
                return getObjKeys(items);
            },
            getObjectValues: function (items) {
                return getObjVals(items);
            },
            parseJson: function () {
                var items = [].slice.apply(arguments);
                return items.reduce(function(acc, item) {
                    return acc + "\nObject\n" + JSON.stringify(item, null, 4);
                }, "");
            }
        });

        function parseJson() {
            var items = [].slice.apply(arguments);
            return items.reduce(function(acc, item) {
                return acc + "\nObject\n" + JSON.stringify(item, null, 4);
            }, "");
        }

        function flattenJson(data) {
            var result = {};
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    for (var deepKey in data[key]) {
                        if (data[key].hasOwnProperty(deepKey)) {
                            result[deepKey] = data[key][deepKey];
                        }
                    }
                }
            }
            return result;
        }
    </script>
</dom-module>