<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="app-theme.html">
<dom-module id="food-grid">
    <style include="app-theme">
        :host {
            display: block;
        }

        #grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        paper-tabs {
            margin-top: 1px;
            margin-bottom: 12.5px;
            --paper-icon-button: {
                color: var(--alt-accent-color);
                background-color: var(--accent-color);
                border-radius: 50%;
                /*display: none;*/
            }
        }
    </style>
    <template>
        <firebase-document
            path="/categories"
            data="{{latestCategories}}">
        </firebase-document>
        <firebase-document
            path="/stores/[[udata.storeId]]/stock"
            data="{{stockData}}">
        </firebase-document>
        <!--<firebase-document
            path="/users/[[udata.id]]/cart/[[udata.storeId]]"
            data="{{udata.cart}}">
        </firebase-document>-->
        <template is="dom-if" if="[[show(store, count, userCartQuanta)]]">
            <a class="linkNullify" href="/cart" tabindex="-1"><paper-button raised><iron-icon icon="my-icons:cart"></iron-icon>Proceed to Cart</paper-button></a>
        </template>
        <template is="dom-if" if="[[store]]">
            <paper-input
                autocorrect="off"
                label="Search"
                value="{{search}}">
                <iron-icon icon="my-icons:search" prefix></iron-icon>
            </paper-input>
            <paper-tabs selected="{{menuSelect}}" autoselect scrollable fit-container>
                <paper-tab>All</paper-tab>
                <template is="dom-repeat" items="[[getObjectValues(latestCategories)]]">
                    <paper-tab>[[capitalize(item)]]</paper-tab>
                </template>
            </paper-tabs>
        </template>
        <div id="grid">
            <template id="rGrid" is="dom-repeat" items="[[getObjectValues(stockData)]]" filter="matchesFilters">
                <food-card
                    id="food[[item.id]]"
                    store="{{store}}"
                    cart="{{cart}}"
                    item="[[item]]"
                    user-id="[[udata.id]]"
                    store-id="[[udata.storeId]]">
                </food-card>
            </template>
        </div>
        <template is="dom-if" if="[[emptyView(count, userCartQuanta, cart, store)]]">
            <template is="dom-if" if="[[store]]">
                <h4 class="center"><b>Your Stock Selection is Empty!</b><br>Select a different store:<br><br><menu-select store></menu-select><br><br>Or change your:<br><b>Search Query Keywords</b></h4><br>
            </template>
            <template is="dom-if" if="[[cart]]">
                <h4 class="center"><b>Your Cart is Empty!</b><br>Add items to your cart here:<br></h4><a class="linkNullify" name="cart" href="/store" tabindex="-1"><paper-button raised><iron-icon icon="my-icons:store"></iron-icon>Store</paper-button></a><br>
            </template>
        </template>
        <template is="dom-if" if="[[show(cart, count, userCartQuanta)]]">
            <total-price
                cart="{{cart}}"
                categories="{{getObjectKeys(latestCategories)}}"
                data="{{stockData}}"
                user-id="[[udata.id]]"
                store-id="[[udata.storeId]]"
                quantities="[[udata.cart]]">
            </total-price>
            <a class="linkNullify" href="/checkout" tabindex="-1"><paper-button raised style="margin-top: 14.5px;"><iron-icon icon="my-icons:checkout"></iron-icon>Proceed to Checkout</paper-button></a>
        </template>
    </template>
    <script>
        Polymer({
            is: 'food-grid',
            properties: {
                stockData: {
                    type: Object,
                    observer: 'refreshGrid'
                }, count: {
                    type: Number,
                    notify: true,
                    value: 0
                }, userCartQuanta: {
                    type: Number,
                    notify: true,
                    computed: 'cartRefresh(udata.cart, udata.storeId)'
                }, store: {
                    type: Boolean,
                    notify: true,
                    value: false,
                    observer: 'refreshGrid'
                }, cart: {
                    type: Boolean,
                    notify: true,
                    value: false,
                    observer: 'refreshGrid'
                }, category: {
                    type: String,
                    notify: true,
                    computed: "getCurrentCategory(menuSelect, latestCategories)",
                    observer: 'refreshGrid'
                }, menuSelect: {
                    type: Number,
                    value: 0,
                    notify: true,
                    observer: 'refreshGrid'
                }, search: {
                    type: String,
                    value: "",
                    notify: true,
                    observer: 'refreshGrid'
                }
            },
            listeners: {
                'foodQuantaChanged': 'cartRefresh',
                'otherRefreshed': 'handleOtherGridChange',
            },
            show: function(view, count, cartCount) {
                return view && cartCount > 0;
            },
            emptyView: function(count, cartCount, c, s) {
                return c ? count == 0 || cartCount == 0 : count == 0;
            },
            getCurrentCategory: function(m, c) {
                if (m == 0) return "all";
                return c[m - 1];
            },
            handleOtherGridChange: function() {
                // log(this.id+" recieved otherRefreshed");
                // this.cartRefresh(null, null, true);
            },
            // cartRefresh: function(data, dontCallRefresh, dontCallSelf) {
            cartRefresh: function(data, id) {
                return getObjectValues(data[id]).reduce((a, b) => isInt(b) ? a + parseInt(b) : 0, 0);
                // log("=============================CART REFRESH============================");
                // log("dontCallRefresh");
                // log(dontCallRefresh);
                // if(!(dontCallRefresh === true))
                //     log("dontCallRefresh is... good!");
                // log("dontCallSelf");
                // log(dontCallSelf);
                // if(!(dontCallSelf === true))
                //     log("dontCallSelf is... good!");
                // else
                //     log(this.id + " got called by otherRefreshed");
                // cartSum = 0;
                // for(var food in getObjectKeys(this.stockData))
                //     if(this.$$("#food"+getObjectKeys(this.stockData)[food]) && isInt(this.$$("#food"+getObjectKeys(this.stockData)[food]).quanta))
                //         cartSum += parseInt(this.$$("#food"+getObjectKeys(this.stockData)[food]).quanta, 10);
                // this.set("userCartQuanta", cartSum);
                // log("Food Grid Cart Count - userCartQuanta");
                // log(this.userCartQuanta);
                // if(!(dontCallRefresh === true))
                //     this.refreshGrid(null, true);
                // if(!(dontCallSelf === true))
                //     this.fire('otherRefreshed', {});
                // log("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~");
            },
            refreshGrid: function(data, dontCallRefresh) {
                log("=============================GRID REFRESH============================");
                log("dontCallRefresh");
                log(dontCallRefresh);
                if(!(dontCallRefresh === true))
                    log("dontCallRefresh is... good!");
                this.$.rGrid.render();
                this.set("count", this.$.rGrid.renderedItemCount);
                // var itemCount = 0;
                // for(var food in this.getObjectKeys(this.stockData)) {
                //     // log(this.$$("#food"+this.getObjectKeys(this.stockData)[food]));
                //     if(this.$$("#food"+this.getObjectKeys(this.stockData)[food])) {
                //         log(this.$$("#food"+this.getObjectKeys(this.stockData)[food]).customStyle["--show-food-card"]);
                //         if(this.$$("#food"+this.getObjectKeys(this.stockData)[food]).customStyle["--show-food-card"] != "none")
                //             itemCount += 1;
                //     }
                // }
                // this.set("count", itemCount);
                log("Food Grid Item Count - this.count");
                log(this.count);
                // if(!(dontCallRefresh === true))
                //     this.cartRefresh(null, true, false);
                log("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~");
            },
            matchesFilters: function(item) {
                var show = true;
                if(this.category != "all")
                    show = (item.category == this.category);
                if(show && this.search != "")
                    show = (item.id+item.description+item.category).toLowerCase().indexOf(this.search) >= 0;
                return show;
            },
            capitalize: function (str) {
                return capitalize(str);
            },
            getObjectKeys: function (items) {
                return getObjectKeys(items);
            },
            getObjectValues: function (items) {
                return getObjectValues(items);
            },
            isInt: function (value) {
                return isInt(value);
            },
            flattenJson: function(data) {
                return flattenJson(data);
            },
            parseJson: function () {
                var items = [].slice.apply(arguments);
                return items.reduce(function(acc, item) {
                    return acc + "\nObject\n" + JSON.stringify(item, null, 4);
                }, "");
            }
        });

        function parseJson() {
            var items = [].slice.apply(arguments);
            return items.reduce(function(acc, item) {
                return acc + "\nObject\n" + JSON.stringify(item, null, 4);
            }, "");
        }
    </script>
</dom-module>